# Synthetic Mask Generation

The pipeline in [main.py](main.py) trains and samples a VAE + latent diffusion model **only to generate synthetic segmentation masks** (7 classes, with or without lesion). It does not synthesize CT images or any other modality.

## Dataset generated with this method
- A sample of masks produced by this code is published on Hugging Face: [IISM_brain](https://huggingface.co/datasets/lborrego/IISM_brain). The dataset contains segmentation masks generated by the VAE+LDM pipeline described here.

## Pretrained checkpoints
- VAE and LDM checkpoints are available here: <https://drive.google.com/drive/folders/1m-xTYYYOmgO_v1_betD7p-hkR6Z6Rkfq?usp=drive_link>.
- Create the directories before downloading to avoid path issues: `ckpts_vae/` for the VAE weights and `ckpts_ldm/` for the LDM weights (each script also writes its outputs there when training).

## Setup

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```
On Windows use `Scripts\activate` and set `--num-workers 0` to avoid dataloader pickling issues.

## How to use `main.py`

### 1) Train the mask VAE
```bash
python main.py train_vae \
  --mask-dir data/masks \
  --epochs 50 \
  --batch 8 \
  --image-size 256 \
  --outdir ckpts_vae \
  --num-workers 0
```
Outputs `ckpts_vae/vae_last.pt` (mask-only model).

### 2) Train the latent diffusion model on VAE latents
```bash
python main.py train_ldm \
  --mask-dir data/masks \
  --vae-ckpt ckpts_vae/vae_last.pt \
  --epochs 50 \
  --batch 16 \
  --timesteps 100 \
  --outdir ckpts_ldm \
  --sample-every 500 \
  --num-workers 0
```
Outputs `ckpts_ldm/ldm_last.pt` and, if `--sample-every > 0`, periodic samples in `ckpts_ldm/samples/`.

### 3) Generate synthetic masks (only function of `main.py`)
```bash
python main.py sample \
  --vae-ckpt ckpts_vae/vae_last.pt \
  --ldm-ckpt ckpts_ldm/ldm_last.pt \
  --prompt lesion_visible \  # or no_lesion
  --n 4 \
  --out generated/mask.png \
  --timesteps 100
```
Produces `generated/mask_{prompt}_{i}.png` colored masks. Prompts available: `lesion_visible` and `no_lesion`.

## Quick notes
- Palette and class ids are fixed in [main.py](main.py) (`NUM_CLASSES=7`, `LESION_ID=6`). Classes: 0 background, 1 soft tissue, 2 bone, 3 CSF, 4 white matter, 5 gray matter, 6 infarct (lesion).
- The script never uses CT images; it only consumes binary/multiclass masks.
- Tune `--timesteps`, `--latent`, and `--prompt-dim` if you change model capacity.
- For more hyperparameters see the argument parser in [main.py](main.py).
